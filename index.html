<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Persona</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 style="color: #764ba2; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <i data-lucide="gamepad-2"></i> Campus Persona
            </h1>
            <p style="opacity: 0.7; font-size: 14px; margin-top: 4px; color: #636e72;">Level up your campus life!</p>
        </div>

        <!-- HOME SECTION -->
        <div id="home-section" class="main-section" style="display: block;">
            <div class="profile-card">
                <div class="avatar-section">
                    <div class="avatar">
                        <i data-lucide="graduation-cap" style="font-size: 36px;"></i>
                    </div>
                <div class="player-info">
                    <h2>Kiraitsu M.</h2>
                    <div class="player-type">The Creative Leader</div>
                </div>
            </div>
            <div class="level-section">
                <div class="level-display">
                    <div class="level-number">1</div>
                    <div class="xp-info">
                        <div style="font-size: 14px; font-weight: 600;">0 / 1000 XP</div>
                        <div style="font-size: 12px; opacity: 0.8;">1000 XP to next level</div>
                    </div>
                </div>
                <div class="xp-bar">
                    <div class="xp-fill"></div>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon"><i data-lucide="users"></i></div>
                <div class="stat-label">Social</div>
                <div class="stat-value">85</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i data-lucide="brain"></i></div>
                <div class="stat-label">Academic</div>
                <div class="stat-value">92</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i data-lucide="crown"></i></div>
                <div class="stat-label">Leadership</div>
                <div class="stat-value">78</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i data-lucide="palette"></i></div>
                <div class="stat-label">Creative</div>
                <div class="stat-value">96</div>
            </div>
        </div>
   
        <div class="activities-section">
            <div class="section-title">
                <i data-lucide="calendar-days"></i> Today's Activities
            </div>
            <div class="activity-card">
                <div class="activity-header">
                    <div class="activity-time">09:00</div>
                    <div class="activity-xp">+250 XP</div>
                </div>
                <div class="activity-title">Rapat Tim Marketing</div>
                <div class="activity-location">
                    <i data-lucide="map-pin" style="width: 12px; height: 12px; display: inline;"></i> Ruang Rapat A
                </div>
            </div>
            <div class="activity-card">
                <div class="activity-header">
                    <div class="activity-time">13:30</div>
                    <div class="activity-xp">+180 XP</div>
                </div>
                <div class="activity-title">Workshop Design Thinking</div>
                <div class="activity-location">
                    <i data-lucide="map-pin" style="width: 12px; height: 12px; display: inline;"></i> Lab Komputer 2
                </div>
            </div>
            <div class="activity-card">
                <div class="activity-header">
                    <div class="activity-time">16:00</div>
                    <div class="activity-xp">+120 XP</div>
                </div>
                <div class="activity-title">Hangout with Squad</div>
                <div class="activity-location">
                    <i data-lucide="map-pin" style="width: 12px; height: 12px; display: inline;"></i> Cafeteria
                </div>
            </div>
        </div>

        <div class="daily-missions">
            <div class="section-title">
                <i data-lucide="target"></i> Daily Missions
            </div>
            <div class="mission-item">
                <span>Attend 2 classes</span>
                <span class="mission-progress">2/2 <i data-lucide="check-circle" style="width: 14px; height: 14px; color: #00b894; display: inline;"></i></span>
            </div>
            <div class="mission-item">
                <span>Help 1 friend</span>
                <span class="mission-progress">1/1 <i data-lucide="check-circle" style="width: 14px; height: 14px; color: #00b894; display: inline;"></i></span>
            </div>
            <div class="mission-item">
                <span>Join 1 UKM activity</span>
                <span class="mission-progress">0/1 <i data-lucide="clock" style="width: 14px; height: 14px; color: #fdcb6e; display: inline;"></i></span>
            </div>
            <div class="mission-item" id="qr-mission">
                <span>Scan 3 QR codes</span>
                <span class="mission-progress">0/3 <i data-lucide="clock" style="width: 14px; height: 14px; color: #fdcb6e; display: inline;"></i></span>
            </div>
        </div>

        <div class="social-skills">
            <div class="section-title">
                <i data-lucide="shield-check"></i> Social Skills Unlocked
            </div>
            <div class="skill-item">
                <div class="skill-header">
                    <div class="skill-name">
                        <i data-lucide="message-circle" style="width: 16px; height: 16px; display: inline; margin-right: 8px; color: #764ba2;"></i>
                        Si Paling Diskusi
                    </div>
                    <div class="skill-level">Lv. 8</div>
                </div>
            </div>
            <div class="skill-item">
                <div class="skill-header">
                    <div class="skill-name">
                        <i data-lucide="presentation" style="width: 16px; height: 16px; display: inline; margin-right: 8px; color: #764ba2;"></i>
                        Master Presenter
                    </div>
                    <div class="skill-level">Lv. 6</div>
                </div>
            </div>
            <div class="skill-item">
                <div class="skill-header">
                    <div class="skill-name">
                        <i data-lucide="handshake" style="width: 16px; height: 16px; display: inline; margin-right: 8px; color: #764ba2;"></i>
                        Team Player Pro
                    </div>
                    <div class="skill-level">Lv. 9</div>
                </div>
            </div>
        </div>

        <div style="height: 120px;"></div>

        <button class="floating-btn" onclick="startScanner()">
            <i data-lucide="qr-code"></i>
            <div class="notification-dot"></div>
        </button>

        <!-- Modal Floating QR Scanner -->
        <div id="qrModal" class="qr-modal">
            <div class="qr-modal-content">
                <button class="close-btn" onclick="closeScanner()">✖</button>
                <div id="qr-reader"></div>
            </div>
        </div>

        <div id="navbar-placeholder"></div>
    </div>

    <script>
        // User data management
        let userData = {
            level: 1,
            xp: 0,
            scannedEvents: []
        };

        const xpPerLevel = 1000;
        let qrScanner;

        // Load user data
        function loadUserData() {
            const saved = localStorage.getItem("personaUser");
            if (saved) {
                userData = JSON.parse(saved);
            } else {
                // Default data
                userData = {
                    level: 1,
                    xp: 0,
                    scannedEvents: []
                };
                saveUserData();
            }
            updateUI();
            updateMissionProgress();
        }

        // Save user data
        function saveUserData() {
            localStorage.setItem("personaUser", JSON.stringify(userData));
        }

        // Update UI
        function updateUI() {
            document.querySelector(".level-number").textContent = userData.level;
            
            const currentLevelXP = userData.xp % xpPerLevel;
            const xpToNext = xpPerLevel - currentLevelXP;
            
            document.querySelector(".xp-info").innerHTML = `
                <div style="font-size: 14px; font-weight: 600;">${currentLevelXP} / ${xpPerLevel} XP</div>
                <div style="font-size: 12px; opacity: 0.8;">${xpToNext} XP to next level</div>
            `;
            
            const fillPercentage = (currentLevelXP / xpPerLevel) * 100;
            document.querySelector(".xp-fill").style.width = `${fillPercentage}%`;
        }

        // Update mission progress
        function updateMissionProgress() {
            const scanCount = userData.scannedEvents.length;
            const missionElement = document.getElementById('qr-mission');
            
            if (missionElement) {
                missionElement.innerHTML = `
                    <span>Scan 3 QR codes</span>
                    <span class="mission-progress">${scanCount}/3 
                        ${scanCount >= 3 ? 
                            '<i data-lucide="check-circle" style="width:14px;height:14px;color:#00b894;display:inline;"></i>' :
                            '<i data-lucide="clock" style="width:14px;height:14px;color:#fdcb6e;display:inline;"></i>'}
                    </span>
                `;
                lucide.createIcons();
            }
        }

        // Add XP and handle level up
        function addXP(amount, eventName) {
            const oldLevel = userData.level;
            userData.xp += amount;
            
            // Calculate new level
            const newLevel = Math.floor(userData.xp / xpPerLevel) + 1;
            
            if (newLevel > oldLevel) {
                // Level up!
                userData.level = newLevel;
                saveUserData();
                updateUI();
                showLevelUpNotification(newLevel);
            } else {
                // Just XP gain
                saveUserData();
                updateUI();
                showXPNotification(amount, eventName);
            }
        }

        // Show XP gain notification
        function showXPNotification(xp, eventName) {
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 8px;">✨</div>
                    <div style="font-weight: 700; margin-bottom: 4px;">Selamat!</div>
                    <div style="font-size: 14px;">Kamu dapat +${xp} XP</div>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">${eventName}</div>
                </div>
            `;
            notification.className = 'notification xp';
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Show level up notification
        function showLevelUpNotification(level) {
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 32px; margin-bottom: 12px;">🎉</div>
                    <div style="font-weight: 700; font-size: 18px; margin-bottom: 8px;">LEVEL UP!</div>
                    <div style="font-size: 16px; margin-bottom: 4px;">Sekarang kamu di level ${level}!</div>
                    <div style="font-size: 12px; opacity: 0.8;">Skill baru telah terbuka!</div>
                </div>
            `;
            notification.className = 'notification level-up';
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // Show error notification
        function showErrorNotification(message) {
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 8px;">⚠️</div>
                    <div style="font-size: 14px;">${message}</div>
                </div>
            `;
            notification.className = 'notification error';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // QR Scanner functionality
        function startScanner() {
            const qrModal = document.getElementById("qrModal");
            qrModal.classList.add("show");

            if (!qrScanner) {
                qrScanner = new Html5Qrcode("qr-reader");
            }

            qrScanner.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250 },
                (decodedText) => {
                    qrScanner.stop().then(() => {
                        closeScanner();
                        handleQRScan(decodedText);
                    });
                },
                (error) => {
                    // Silent error handling
                }
            );
        }

        function closeScanner() {
            document.getElementById("qrModal").classList.remove("show");
            if (qrScanner && qrScanner.isScanning) {
                qrScanner.stop().catch(e => console.log("Scanner stop error:", e));
            }
        }

        function handleQRScan(qrText) {
            // Mapping event dan XP
            const eventXP = {
                'marketing_meeting': { xp: 250, name: 'Rapat Tim Marketing' },
                'design_workshop': { xp: 180, name: 'Workshop Design Thinking' },
                'hangout': { xp: 120, name: 'Hangout with Squad' },
                'class_attended': { xp: 100, name: 'Kelas Dihadiri' },
                'ukm_activity': { xp: 200, name: 'Aktivitas UKM' }
            };

            const eventKey = qrText.toLowerCase().replace(/\s+/g, '_');
            
            // Check if already scanned
            if (userData.scannedEvents.includes(eventKey)) {
                showErrorNotification("QR sudah discan sebelumnya!");
                return;
            }

            if (eventXP[eventKey]) {
                // Add to scanned events
                userData.scannedEvents.push(eventKey);
                saveUserData();
                
                // Update mission progress
                updateMissionProgress();
                
                // Add XP
                addXP(eventXP[eventKey].xp, eventXP[eventKey].name);
            } else {
                showErrorNotification("QR tidak valid!");
            }
        }

        // Navigation functionality
        document.querySelectorAll('.nav-item').forEach((item, index) => {
            item.addEventListener('click', function () {
                document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                this.classList.add('active');
                
                const labels = ['Home', 'Friends', 'Stats', 'Quest', 'Profile'];
                if (labels[index] !== 'Friends') {
                    alert(`Navigating to ${labels[index]}...`);
                }
            });
        });

        //Navbar
        fetch("Navbar.html")
        .then(res => res.text())
        .then(data => {
            document.getElementById("navbar-placeholder").innerHTML = data;
            lucide.createIcons(); // untuk refresh icon lucide
        });

        // Initialize app
        window.onload = () => {
            loadUserData();
            lucide.createIcons();
        };

        // Initialize Lucide icons
        lucide.createIcons();

        // Activity cards interaction
        document.querySelectorAll('.activity-card').forEach(card => {
            card.addEventListener('click', function() {
                this.style.transform = 'scale(0.98)';
                setTimeout(() => {
                    this.style.transform = '';
                }, 150);
            });
        });
    </script>
</body>
</html>
